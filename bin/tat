#!/bin/bash

###############################################################
# TMUX Extended Functionality
###############################################################

if [[ $# -eq 0 ]]; then
  path=$PWD
elif [[ $# -eq 1 ]]; then
  #--------------------------------------------------------------
  # edit scrollback
  #--------------------------------------------------------------
  if [ "$1" == "show-scrollback" ]; then
    file=$(mktemp).sh
    tmux capture-pane -pS -32768 > "$file"
    tmux new-window -n:scrollback "nvim -c \"lua require('util.window').term_scrollback()\" $file"
    exit 0
  #--------------------------------------------------------------
  # session launcher
  #--------------------------------------------------------------
  elif [ "$1" == "fzf" ] || [ "$1" == "new" ]; then
    projects_dir=""
    # shellcheck disable=SC2153
    for f in "$PROJECTS_DIR"/*; do
      if [ -z "$projects_dir" ]; then
        projects_dir="$f"
      else
        projects_dir="$projects_dir $f"
      fi
    done
    [[ $1 == "new" ]] && HEIGHT="100%" || HEIGHT="50%"
    # shellcheck disable=SC2207
    projects_dir=($(echo "$projects_dir" | cut -d " " --output-delimiter=" " -f 1-))
    path=$(find -L "$HOME" "$HOME/Git" "$HOME/Projects" "${projects_dir[@]}" \
      -mindepth 1 -maxdepth 1 -type d \
      | fzf --height="${HEIGHT}" --reverse --header='Create/Open Session' \
        --preview '(glow -s dark {1}/README.md ||
          bat --style=plain {1}/README.md ||
          cat {1}/README.md ||
          eza -lh --icons {1} ||
          ls -lh {1}) 2> /dev/null')
    if [ "$path" == "" ]; then
      exit 0
    fi
  #--------------------------------------------------------------
  # persistent flaating window across all sessions
  #--------------------------------------------------------------
  elif [ "$1" == "float" ]; then
    current_client="$(tmux display-message -p -F "#{session_name}")"
    if [ "$current_client" == "float-repl" ]; then
      tmux detach-client
    else
      tmux popup -d '#{pane_current_path}' -xC -yC -w80% -h80% \
        -E "tmux attach -t float-repl || tmux new -s float-repl" || true
    fi
    exit 0
  #--------------------------------------------------------------
  # session switcher
  #--------------------------------------------------------------
  elif [ "$1" == "switch" ]; then
    if not_in_tmux; then
      echo "command only available within tmux"
      exit 1
    fi
    current_client="$(tmux display-message -p -F "#{session_name}")"
    tmux list-sessions -F "#S" \
      | grep -v "^$current_client" \
      | grep -v "^float-repl" \
      | awk 'BEGIN {ORS=" "} {print $1, NR, "\"switch-client -t", $1 "\""}' \
      | xargs tmux display-menu -T "Switch session"
    exit 0
  #--------------------------------------------------------------
  # helper to goto next session
  #--------------------------------------------------------------
  elif [ "$1" == "switch-client-next" ]; then
    if not_in_tmux; then
      echo "command only available within tmux"
      exit 1
    fi
    available_clients=$(tmux list-sessions -F "#S" \
      | grep -v "^float-repl")
    # shellcheck disable=SC2206
    available_clients=(${available_clients//\\n/ })
    current_client="$(tmux display-message -p -F "#{session_name}")"
    if [ "$current_client" == "float-repl" ]; then
      tmux display-message "Client switch not allowed in this session"
    elif [ "${#available_clients[@]}" -eq 1 ]; then
      tmux display-message "Can't switch to next client"
    else
      next_index=0
      for i in "${!available_clients[@]}"; do
        if [[ ${available_clients[$i]} == "${current_client}" ]]; then
          next_index=$((i + 1))
        fi
      done
      if [ "${#available_clients[@]}" -le "${next_index}" ]; then
        next_index=0
      fi
      tmux switch-client -t "${available_clients[$next_index]}"
    fi
    exit 0
  #--------------------------------------------------------------
  # helper to goto previous session
  #--------------------------------------------------------------
  elif [ "$1" == "switch-client-previous" ]; then
    if not_in_tmux; then
      echo "command only available within tmux"
      exit 1
    fi
    # shellcheck disable=SC2178
    available_clients=$(tmux list-sessions -F "#S" \
      | grep -v "^float-repl")
    # shellcheck disable=SC2206
    available_clients=(${available_clients//\\n/ })
    current_client="$(tmux display-message -p -F "#{session_name}")"
    if [ "$current_client" == "float-repl" ]; then
      tmux display-message "Client switch not allowed in this session"
    elif [ "${#available_clients[@]}" -eq 1 ]; then
      tmux display-message "Can't switch to previous client"
    else
      next_index=${#available_clients[@]}
      for i in "${!available_clients[@]}"; do
        if [[ ${available_clients[$i]} == "${current_client}" ]]; then
          next_index=$((i - 1))
        fi
      done
      if [ "${next_index}" -lt 0 ]; then
        next_index=${#available_clients[@]}
        tmux switch-client -t "${available_clients[$((next_index - 1))]}"
      else
        tmux switch-client -t "${available_clients[$next_index]}"
      fi
    fi
    exit 0
  else
    echo "'$1' is not a supported argument at this time"
    exit 1
  fi
else
  echo "unsupported number of arguments: 0 or 1 expected, got $#"
  exit 1
fi

session_name="$(basename "$path" | tr . _)"

not_in_tmux() {
  [ -z "$TMUX" ]
}

session_exists() {
  tmux list-sessions | sed -E 's/:.*$//' | grep -q "^$session_name$"
}

create_detached_session() {
  (TMUX='' tmux new-session -Ad -s "$session_name" -c "$path")
}

create_if_needed_and_attach() {
  if not_in_tmux; then
    tmux new-session -As "$session_name" -c "$path"
  else
    if ! session_exists; then
      create_detached_session
    fi
    tmux switch-client -t "$session_name"
  fi
}

create_if_needed_and_attach
