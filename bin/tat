#!/bin/bash

if [[ $# -eq 0 ]]; then
  path=$PWD
elif [[ $# -eq 1 ]]; then
  if [ "$1" == "edit" ]; then
    file=$(mktemp).sh
    tmux capture-pane -pS -32768 > "$file"
    tmux new-window -n:mywindow "nvim '+ normal G $' $file"
    exit 0
  elif [ "$1" == "fzf" ] || [ "$1" == "new" ]; then
    projects_dir=""
    # shellcheck disable=SC2153
    for f in "$PROJECTS_DIR"/*; do
      if [ -z "$projects_dir" ]; then
        projects_dir="$f"
      else
        projects_dir="$projects_dir $f"
      fi
    done
    [[ $1 == "new" ]] && HEIGHT="100%" || HEIGHT="50%"
    # shellcheck disable=SC2207
    projects_dir=($(echo "$projects_dir" | cut -d " " --output-delimiter=" " -f 1-))
    path=$(find -L "$HOME" "$HOME/Git" "$HOME/Projects" "${projects_dir[@]}" \
      -mindepth 1 -maxdepth 1 \
      | fzf --height="${HEIGHT}" --reverse --header='Create/Open Session' \
        --preview '(glow -s dark {1}/README.md ||
          bat --style=plain {1}/README.md ||
          cat {1}/README.md ||
          eza -lh --icons {1} ||
          ls -lh {1}) 2> /dev/null')
    if [ "$path" == "" ]; then
      exit 0
    fi
  elif [ "$1" == "float" ]; then
    current_pane="$(tmux display-message -p -F "#{session_name}")"
    if [ "$current_pane" == "float-repl" ]; then
      tmux detach-client
    else
      tmux popup -d '#{pane_current_path}' -xC -yC -w80% -h80% \
        -E "tmux attach -t float-repl || tmux new -s float-repl" || true
    fi
    exit 0
  elif [ "$1" == "switch" ]; then
    if not_in_tmux; then
      echo "command only available within tmux"
      exit 1
    fi
    tmux list-sessions -F '#S' \
      | awk 'BEGIN {ORS=" "} {print $1, NR, "\"switch-client -t", $1 "\""}' \
      | xargs tmux display-menu -T "Switch session"
    exit 0
  else
    echo "'$1' is not a supported argument at this time"
    exit 1
  fi
else
  echo "unsupported number of arguments: 0 or 1 expected, got $#"
  exit 1
fi

session_name="$(basename "$path" | tr . _)"

not_in_tmux() {
  [ -z "$TMUX" ]
}

session_exists() {
  tmux list-sessions | sed -E 's/:.*$//' | grep -q "^$session_name$"
}

create_detached_session() {
  (TMUX='' tmux new-session -Ad -s "$session_name" -c "$path")
}

create_if_needed_and_attach() {
  if not_in_tmux; then
    tmux new-session -As "$session_name" -c "$path"
  else
    if ! session_exists; then
      create_detached_session
    fi
    tmux switch-client -t "$session_name"
  fi
}

create_if_needed_and_attach
