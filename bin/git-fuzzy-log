#!/bin/bash

GIT_FZF_DEFAULT_OPTS="
  $FZF_DEFAULT_OPTS
  --height=100%
"
git-fuzzy-log() {
  # shellcheck disable=SC2016
  PREVIEW_COMMAND='f() {
    set -- $(echo -- "$@" | grep -o "[a-f0-9]\{7\}")
    [ $# -eq 0 ] || git show --color=always $1 | delta 
  }; f {}'

  ENTER_COMMAND='(grep -o "[a-f0-9]\{7\}" | head -1 |
    xargs -I % sh -c "git show --color=always % | delta") << "FZF-EOF"
    {}
    FZF-EOF'

  # shellcheck disable=SC2086
  # shellcheck disable=SC2068
  git log --graph --color=always --format='%C(auto)%h %an %C(blue)%s %C(magenta)%cr' $@ \
    | fzf ${GIT_FZF_DEFAULT_OPTS} --no-sort --tiebreak=index \
      --preview "${PREVIEW_COMMAND}" --preview-window=top:15 \
      --bind "enter:execute:${ENTER_COMMAND}"
}

git-fuzzy-log "@"
